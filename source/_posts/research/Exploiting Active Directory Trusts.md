---
cover: https://i.postimg.cc/ZK6QqchB/trusts.jpg
title: "Infiltrating the Domain: Exploiting Active Directory Trusts"
date: 9/01/2024 5:22:33 +08:03
categories: research
tags: [Active Directory Trust]
toc: true
toc_number: false
---
# Overview
In active directory trust is a relationship between two domain or forest which allows users or groups of one domain or forest to authenticate and access resources of another domain or forest or vice versa. 

## One Way Trust
![One Way Trust](https://i.postimg.cc/Y9JV7Tgv/one-way-trust-drawio.png)
This is also known as one direction trust where users or groups in trusted domain can access resources in trusting domain but the reverse is not true. For example in a forest `alex.local` there is a child domain `development.alex.local` and there is another forest` dhital.local` which has its child domain `management.dhital.local`. If `development.alex.local` is configured to trust `management.dhital.local` then `development.alex.local` is the trusting domain wheares `management.dhital.local` is the trusted domain so users/groups in `management.dhital.local` can authenticate and access resources of `development.alex.local` but vice versa is not true.

## Two way trust(Bi-directional trust)
![](https://i.postimg.cc/XJ6t5TH9/bidirectional.jpg)
Two way trust also called as bi-directional trust is a trust relationship where users or groups of one domain or forest can access each other's resources. This type of trust is automatically created between domains inside a forest. For example in the above diagram The root domain is `alex.local` which has two child domains `development.alex.local` and `finance.alex.local`. Both development and finance can access each other resources as well as can access resource in `alex.local` itself.

**Note:** In a forest if one domain is compromised the entire forest can be compromised since domains inside a forest has bi-directional trust with each other. eg: If `management.alex.local` is compromised due to bi-directional parent child trust alex.local can be compromised.

## Transitive Trust
![](https://i.postimg.cc/2jPFDM8f/bi-directionall-drawio.png)
This kind of trust exists automatically between domains inside a forest. For example in a forest `alex.local` there are three domains development, finance and management. If `development.alex.local` has bi directional trust with `finance.alex.local` and `finance.alex.local` has bi directional trust with `management.alex.local` then development domain has bi directional trust automatically with management.

## Non transitive trust
It means if domain A trusts domain B and domain B trusts domain C then domain A does not trust domain C automatically and a separate trust needs to be established between them. This type of trust relationship automatically exists between two domains in different forest.

## Parent Child trust
This is same as bi-directional trust. It is created automatically between forest root and child domains. example: child domain `management.alex.local` and forest root which is the parent domain `alex.local` can access each other's resources.

## Tree root trust
It is automatically created between trees in a forest. For example in a forest alex.local there are three domains development, finance and management and management has child domain `in.management.alex.local`. If `in.management.alex.local` is compromised due to bi directional trust `management.alex.local` can be compromised and again due to bi-directional trust `alex.local` forest itself can be compromised.

## External trust
This needs to be created manually. This trust is manually established by enterprise administrator between domains in two different forests. For example: two forests `alex.local` and `dhital.local`. `alex.local` has two child domains `development.alex.local` and `management.alex.local`. The forest `dhital.local` has `sales.dhital.local` and `IT.dhital.local`. Here, enterprise administrators can setup one way or two way trust between `development.alex.local` and `sales.dhital.local` or with any other domain. 

## Kerberos working inside forest.
![](https://i.postimg.cc/0NPVhhW5/inter-forest-drawio.png)
Suppose a client in `management.alex.local` wants to access a service residing in parent domain `alex.local` how does he do it?
- The client asks for TGT with authentication server.(current domain's dc)
- The authentication server sends TGT to the client.(current domain's dc)
- The client presents this TGT along with spn `MSSQL\sql.alex.local` to the ticket granting server(current domain's dc) and asks for ST for MSSQL service residing in cyberbotic.io domain.
- The DC checks the spn and provides inter forest TGT(This inter forest TGT is encrypted using trust key for parent and child domains. This trust key is present in dc of both domains.)
- Client presents this inter forest TGT to DC of parent domain and asks for ST 
- The parent domain's DC decrypts this inter forest TGT using its own trust key and if successfull presents ST to the client.
- The client presents this service ticket to the service in parent domain.
- The service provides or denies access.
